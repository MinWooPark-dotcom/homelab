- name: Reset Kubernetes node
  hosts: all
  become: yes
  vars_files:
    - vault.yml
  tasks:
    - name: Reset kubeadm
      command: kubeadm reset -f

    - name: Remove CNI configs
      file:
        path: /etc/cni/net.d
        state: absent

    - name: Remove CNI state
      file:
        path: /var/lib/cni
        state: absent

    - name: Remove kubeconfig
      file:
        path: "{{ lookup('env','HOME') }}/.kube/config"
        state: absent
      become: false
      when: "'master' in group_names"

    - name: Restart containerd
      service:
        name: containerd
        state: restarted
